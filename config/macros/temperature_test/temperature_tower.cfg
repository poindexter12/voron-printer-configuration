[gcode_macro TEMPERATURE_TOWER]
gcode:
  # Parameters
  {% set target = params.TARGET|default(200)|float %}
  {% set offsets = [15, 10, 5, 0, -5, -10] %}
  {% set bed_temp = params.BED_TEMP|default(85)|float%}

  ;M80 ; power supply on
  G90
  M82
  M106 S0
  M140 S{bed_temp} ; custom bed temp
  M190 S{bed_temp} ; custom bed temp
  {% set starting_temperature = (target - 50)|int %}
  M104 S{starting_temperature} T0
  G28 ; home all axes
  QUAD_GANTRY_LEVEL
  BED_MESH_CALIBRATE ; Klipper equivalent of G29
  G28
  ;M420 S1 ; restore ABL mesh

  # Starting temperature for base layer
  #####################################################################
  {% set base_layer_temperature = (target + offsets[1])|int %}
  M109 S{ base_layer_temperature } T0
  #####################################################################

  G92 E0.0000
  G1 E-0.8 F2400 ; custom retraction
  ;fan1;
  G1 Z0.160 F1200
  G1 X146.3780 Y167.5720 F6000
  G1 E0.05 F2400 ; custom un-retraction/prime
  G92 E0.0000
  G1 X147.4300 Y167.1360 E0.0393 F1800
  G1 X202.5700 Y167.1360 E1.9407
  G1 X203.6220 Y167.5720 E1.9800
  G1 X207.4280 Y171.3780 E2.1656
  G1 X207.8640 Y172.4300 E2.2049
  G1 X207.8640 Y177.5700 E2.3821
  G1 X207.4280 Y178.6220 E2.4214
  G1 X203.6220 Y182.4280 E2.6070
  G1 X202.5700 Y182.8640 E2.6463
  G1 X147.4300 Y182.8640 E4.5477
  G1 X146.3780 Y182.4280 E4.5870
  G1 X142.5720 Y178.6220 E4.7726
  G1 X142.1360 Y177.5700 E4.8119
  G1 X142.1360 Y172.4300 E4.9891
  G1 X142.5720 Y171.3780 E5.0284
  G1 X146.3780 Y167.5720 E5.2140
  G92 E0.0000
  G1 E-0.8 F2400 ; custom retraction
  G91;
  G1 Z0.5 F1200; custom z hop
  G90;
  G1 X146.7040 Y168.0600 F6000
  G1 Z0.160 F1200
  G1 E0.05 F2400 ; custom un-retraction/prime
  G92 E0.0000
  G1 X147.5450 Y167.7120 E0.0314 F1800
  G1 X202.4550 Y167.7120 E1.9249
  G1 X203.2960 Y168.0600 E1.9563
  G1 X206.9400 Y171.7040 E2.1340
  G1 X207.2880 Y172.5450 E2.1654
  G1 X207.2880 Y177.4550 E2.3347
  G1 X206.9400 Y178.2960 E2.3661
  G1 X203.2960 Y181.9400 E2.5438
  G1 X202.4550 Y182.2880 E2.5752
  G1 X147.5450 Y182.2880 E4.4687
  G1 X146.7040 Y181.9400 E4.5001
  G1 X143.0600 Y178.2960 E4.6778
  G1 X142.7120 Y177.4550 E4.7092
  G1 X142.7120 Y172.5450 E4.8785
  G1 X143.0600 Y171.7040 E4.9099
  G1 X146.7040 Y168.0600 E5.0876
  G92 E0.0000
  G1 E-0.8 F2400 ; custom retraction
  G91;
  G1 Z0.5 F1200; custom z hop
  G90;
  G1 X148.1190 Y170.2880 F6000
  G1 X148.0120 Y170.3960
  G1 X148.5960 Y171.4400
  G1 Z0.160 F1200
  G1 E0.05 F2400 ; custom un-retraction/prime
  G92 E0.0000
  G1 X201.4040 Y171.4400 E1.8210 F1440
  G1 X203.5600 Y173.5960 E1.9262
  G1 X203.5600 Y176.4040 E2.0230
  G1 X201.4040 Y178.5600 E2.1281
  G1 X148.5960 Y178.5600 E3.9491
  G1 X146.4400 Y176.4040 E4.0543
  G1 X146.4400 Y173.5960 E4.1511
  G1 X148.5960 Y171.4400 E4.2563
  G1 X148.3580 Y170.8640 F6000
  G92 E0.0000
  G1 X201.6420 Y170.8640 E1.8375 F1440
  G1 X204.1360 Y173.3580 E1.9591
  G1 X204.1360 Y176.6420 E2.0723
  G1 X201.6420 Y179.1360 E2.1940
  G1 X148.3580 Y179.1360 E4.0314
  G1 X145.8640 Y176.6420 E4.1530
  G1 X145.8640 Y173.3580 E4.2663
  G1 X148.3580 Y170.8640 E4.3879
  G1 X148.1190 Y170.2880 F6000
  G92 E0.0000
  G1 X201.8810 Y170.2880 E1.8539 F1080
  G1 X204.7120 Y173.1190 E1.9920
  G1 X204.7120 Y176.8810 E2.1217
  G1 X201.8810 Y179.7120 E2.2598
  G1 X148.1190 Y179.7120 E4.1137
  G1 X145.2880 Y176.8810 E4.2518
  G1 X145.2880 Y173.1190 E4.3815
  G1 X148.1190 Y170.2880 E4.5196
  G1 X148.8890 Y178.2140 F6000
  G92 E0.0000
  G1 X146.7860 Y176.1110 E0.1026 F1440
  G1 X146.7860 Y175.2960 E0.1307
  G1 X149.7040 Y178.2140 E0.2730
  G1 X150.5180 Y178.2140 E0.3011
  G1 X146.7860 Y174.4820 E0.4831
  G1 X146.7860 Y173.7400 E0.5087
  G1 X146.8220 Y173.7030 E0.5105
  G1 X151.3330 Y178.2140 E0.7305
  G1 X152.1480 Y178.2140 E0.7586
  G1 X147.2290 Y173.2960 E0.9984
  G1 X147.6370 Y172.8890 E1.0183
  G1 X152.9620 Y178.2140 E1.2780
  G1 X153.7770 Y178.2140 E1.3061
  G1 X148.0440 Y172.4810 E1.5857
  G1 X148.4510 Y172.0740 E1.6056
  G1 X154.5910 Y178.2140 E1.9050
  G1 X155.4060 Y178.2140 E1.9331
  G1 X148.9770 Y171.7860 E2.2466
  G1 X149.7920 Y171.7860 E2.2747
  G1 X156.2210 Y178.2140 E2.5882
  G1 X157.0350 Y178.2140 E2.6163
  G1 X150.6060 Y171.7860 E2.9298
  G1 X151.4210 Y171.7860 E2.9579
  G1 X157.8500 Y178.2140 E3.2714
  G1 X158.6640 Y178.2140 E3.2995
  G1 X152.2360 Y171.7860 E3.6131
  G1 X153.0500 Y171.7860 E3.6411
  G1 X159.4790 Y178.2140 E3.9547
  G1 X160.2930 Y178.2140 E3.9828
  G1 X153.8650 Y171.7860 E4.2963
  G1 X154.6790 Y171.7860 E4.3244
  G1 X161.1080 Y178.2140 E4.6379
  G1 X161.9230 Y178.2140 E4.6660
  G1 X155.4940 Y171.7860 E4.9795
  G1 X156.3080 Y171.7860 E5.0076
  G1 X162.7370 Y178.2140 E5.3211
  G1 X163.5520 Y178.2140 E5.3492
  G1 X157.1230 Y171.7860 E5.6627
  G1 X157.9380 Y171.7860 E5.6908
  G1 X164.3660 Y178.2140 E6.0043
  G1 X165.1810 Y178.2140 E6.0324
  G1 X158.7520 Y171.7860 E6.3459
  G1 X159.5670 Y171.7860 E6.3740
  G1 X165.9960 Y178.2140 E6.6875
  G1 X166.8100 Y178.2140 E6.7156
  G1 X160.3810 Y171.7860 E7.0292
  G1 X161.1960 Y171.7860 E7.0572
  G1 X167.6250 Y178.2140 E7.3708
  G1 X168.4390 Y178.2140 E7.3989
  G1 X162.0110 Y171.7860 E7.7124
  G1 X162.8250 Y171.7860 E7.7405
  G1 X169.2540 Y178.2140 E8.0540
  G1 X170.0690 Y178.2140 E8.0821
  G1 X163.6400 Y171.7860 E8.3956
  G1 X164.4540 Y171.7860 E8.4237
  G1 X170.8830 Y178.2140 E8.7372
  G1 X171.6980 Y178.2140 E8.7653
  G1 X165.2690 Y171.7860 E9.0788
  G1 X166.0840 Y171.7860 E9.1069
  G1 X172.5120 Y178.2140 E9.4204
  G1 X173.3270 Y178.2140 E9.4485
  G1 X166.8980 Y171.7860 E9.7620
  G1 X167.7130 Y171.7860 E9.7901
  G1 X174.1410 Y178.2140 E10.1036
  G1 X174.9560 Y178.2140 E10.1317
  G1 X168.5270 Y171.7860 E10.4452
  G1 X169.3420 Y171.7860 E10.4733
  G1 X175.7710 Y178.2140 E10.7869
  G1 X176.5850 Y178.2140 E10.8149
  G1 X170.1560 Y171.7860 E11.1285
  G1 X170.9710 Y171.7860 E11.1566
  G1 X177.4000 Y178.2140 E11.4701
  G1 X178.2140 Y178.2140 E11.4982
  G1 X171.7860 Y171.7860 E11.8117
  G1 X172.6000 Y171.7860 E11.8398
  G1 X179.0290 Y178.2140 E12.1533
  G1 X179.8440 Y178.2140 E12.1814
  G1 X173.4150 Y171.7860 E12.4949
  G1 X174.2290 Y171.7860 E12.5230
  G1 X180.6580 Y178.2140 E12.8365
  G1 X181.4730 Y178.2140 E12.8646
  G1 X175.0440 Y171.7860 E13.1781
  G1 X175.8590 Y171.7860 E13.2062
  G1 X182.2870 Y178.2140 E13.5197
  G1 X183.1020 Y178.2140 E13.5478
  G1 X176.6730 Y171.7860 E13.8613
  G1 X177.4880 Y171.7860 E13.8894
  G1 X183.9170 Y178.2140 E14.2029
  G1 X184.7310 Y178.2140 E14.2310
  G1 X178.3020 Y171.7860 E14.5446
  G1 X179.1170 Y171.7860 E14.5726
  G1 X185.5460 Y178.2140 E14.8862
  G1 X186.3600 Y178.2140 E14.9143
  G1 X179.9310 Y171.7860 E15.2278
  G1 X180.7460 Y171.7860 E15.2559
  G1 X187.1750 Y178.2140 E15.5694
  G1 X187.9890 Y178.2140 E15.5975
  G1 X181.5610 Y171.7860 E15.9110
  G1 X182.3750 Y171.7860 E15.9391
  G1 X188.8040 Y178.2140 E16.2526
  G1 X189.6190 Y178.2140 E16.2807
  G1 X183.1900 Y171.7860 E16.5942
  G1 X184.0040 Y171.7860 E16.6223
  G1 X190.4330 Y178.2140 E16.9358
  G1 X191.2480 Y178.2140 E16.9639
  G1 X184.8190 Y171.7860 E17.2774
  G1 X185.6340 Y171.7860 E17.3055
  G1 X192.0620 Y178.2140 E17.6190
  G1 X192.8770 Y178.2140 E17.6471
  G1 X186.4480 Y171.7860 E17.9607
  G1 X187.2630 Y171.7860 E17.9887
  G1 X193.6920 Y178.2140 E18.3023
  G1 X194.5060 Y178.2140 E18.3303
  G1 X188.0770 Y171.7860 E18.6439
  G1 X188.8920 Y171.7860 E18.6720
  G1 X195.3210 Y178.2140 E18.9855
  G1 X196.1350 Y178.2140 E19.0136
  G1 X189.7070 Y171.7860 E19.3271
  G1 X190.5210 Y171.7860 E19.3552
  G1 X196.9500 Y178.2140 E19.6687
  G1 X197.7650 Y178.2140 E19.6968
  G1 X191.3360 Y171.7860 E20.0103
  G1 X192.1500 Y171.7860 E20.0384
  G1 X198.5790 Y178.2140 E20.3519
  G1 X199.3940 Y178.2140 E20.3800
  G1 X192.9650 Y171.7860 E20.6935
  G1 X193.7790 Y171.7860 E20.7216
  G1 X200.2080 Y178.2140 E21.0351
  G1 X201.0230 Y178.2140 E21.0632
  G1 X194.5940 Y171.7860 E21.3767
  G1 X195.4090 Y171.7860 E21.4048
  G1 X201.5490 Y177.9260 E21.7043
  G1 X201.9560 Y177.5190 E21.7241
  G1 X196.2230 Y171.7860 E22.0037
  G1 X197.0380 Y171.7860 E22.0318
  G1 X202.3630 Y177.1110 E22.2915
  G1 X202.7710 Y176.7040 E22.3114
  G1 X197.8520 Y171.7860 E22.5513
  G1 X198.6670 Y171.7860 E22.5794
  G1 X203.1780 Y176.2970 E22.7994
  G1 X203.2140 Y176.2600 E22.8011
  G1 X203.2140 Y175.5180 E22.8267
  G1 X199.4820 Y171.7860 E23.0088
  G1 X200.2960 Y171.7860 E23.0368
  G1 X203.2140 Y174.7040 E23.1792
  G1 X203.2140 Y173.8890 E23.2072
  G1 X201.1110 Y171.7860 E23.3098
  G92 E0.0000
  G1 E-0.8 F2400 ; custom retraction

  {% set layer_1_temperature = (target + offsets[1])|int %}
  TOWER_LAYER HOTEND_TEMPERATURE={ layer_1_temperature } Z_HOP={ 0.5 } Z_START={ 0.32 } Z_DELTA={ 0.16 }

  G28 X115.0000 ; home X axis
  M106 S0 ; turn off cooling fan
  M104 S0 ; turn off extruder
  M140 S0 ; turn off bed
  M84 ; disable motors
  ;customend
