[gcode_macro _CALIBRATION_BLOCK]
description: Internal helper that prints one full calibration block (hidden)
gcode:
    # _CALIBRATION_BLOCK — prints an entire calibration block
    # A calibration block consists of N physical layers. The first layer is a
    # marker layer (adds corner ticks), remaining layers are calibration layers.
    #
    # Parameters (passed by the invoker):
    #   RETRACTION_DISTANCE       : base retraction length for this block (mm)
    #   RETRACTION_SPEED_MMS      : retraction speed for this block (mm/s)
    #   NOZZLE_TEMPERATURE        : nozzle temperature to set at start of block (°C)
    #   FAN_SPEED_PERCENT         : fan speed percent for this block (0-100)
    #   LAYERS_PER_CALIBRATION_BLOCK : number of physical layers in this block (default 25)
    #
    # Optional (sensible defaults, can be overridden by invoker):
    #   RETRACTION_DISTANCE_INCREMENT : per-layer increment added to RETRACTION_DISTANCE (mm, default 0)
    #   LAYER_HEIGHT_MM           : layer height in mm (default 0.2)
    #   STARTING_Z_HEIGHT         : starting Z for this block; defaults to current Z
    #
    {% set retraction_distance              = params.RETRACTION_DISTANCE|default(0.5)|float %}
    {% set retraction_speed_mms             = params.RETRACTION_SPEED_MMS|default(10)|float %}          # mm/s
    {% set nozzle_temperature               = params.NOZZLE_TEMPERATURE|default(210)|float %}
    {% set fan_speed_percent                = params.FAN_SPEED_PERCENT|default(40)|float %}                 # 0..100
    {% set layers_per_calibration_block     = params.LAYERS_PER_CALIBRATION_BLOCK|default(25)|int %}

    {% set retraction_distance_increment    = params.RETRACTION_DISTANCE_INCREMENT|default(0.0)|float %}
    {% set layer_height_mm                  = params.LAYER_HEIGHT_MM|default(0.2)|float %}
    {% set starting_z_height                = params.STARTING_Z_HEIGHT|default(printer.toolhead.position.z)|float %}

    {% set retraction_feed_rate_mmpm        = (retraction_speed_mms * 60.0) %}                   # mm/min
    {% set fan_speed_pwm                    = (fan_speed_percent/100.0*255) | int %}
    {% set waypoints_per_square            = params.WAYPOINTS_PER_SQUARE|default(4)|int %}
    {% set retraction_distance_waypoint_increment = params.RETRACTION_DISTANCE_WAYPOINT_INCREMENT|default(0.0)|float %}

    {% set print_speed_mm_per_min = (printer.gcode_move.speed) if printer.gcode_move.speed else 2400 %}

    ; --- Apply per-block conditions ---
    M104 S{nozzle_temperature}
    M106 S{fan_speed_pwm}

    ; --- Marker layer (outside loop) ---
    {% set current_retraction_distance = retraction_distance %}
    {% set current_layer_z = starting_z_height %}
    G90
    G1 Z{current_layer_z} F300

    ; ===== Marker layer (indicator grid) =====
    G1 F1200 X145.0 Y205.0 E154.79775
    G0 F6000 X146.0 Y205.0
    G1 F1200 X146.0 Y145.0 E157.33542
    G0 F6000 X147.0 Y145.0
    G1 F1200 X147.0 Y205.0 E159.87309
    G0 F6000 X148.0 Y205.0
    G1 F1200 X148.0 Y145.0 E162.41076
    G0 F6000 X149.0 Y145.0
    G1 F1200 X149.0 Y205.0 E164.94842
    G0 F6000 X150.0 Y205.0
    G1 F1200 X150.0 Y145.0 E167.48609
    G0 F6000 X151.0 Y145.0
    G1 F1200 X151.0 Y205.0 E170.02376
    G0 F6000 X152.0 Y205.0
    G1 F1200 X152.0 Y145.0 E172.56143
    G0 F6000 X153.0 Y145.0
    G1 F1200 X153.0 Y205.0 E175.09910
    G0 F6000 X154.0 Y205.0
    G1 F1200 X154.0 Y145.0 E177.63676
    G0 F6000 X155.0 Y145.0
    G1 F1200 X155.0 Y205.0 E180.17443
    G0 F6000 X156.0 Y205.0
    G1 F1200 X156.0 Y145.0 E182.71210
    G0 F6000 X157.0 Y145.0
    G1 F1200 X157.0 Y205.0 E185.24977
    G0 F6000 X158.0 Y205.0
    G1 F1200 X158.0 Y145.0 E187.78744
    G0 F6000 X159.0 Y145.0
    G1 F1200 X159.0 Y205.0 E190.32510
    G0 F6000 X160.0 Y205.0
    G1 F1200 X160.0 Y145.0 E192.86277
    G0 F6000 X161.0 Y145.0
    G1 F1200 X161.0 Y205.0 E195.40044
    G0 F6000 X162.0 Y205.0
    G1 F1200 X162.0 Y145.0 E197.93811
    G0 F6000 X163.0 Y145.0
    G1 F1200 X163.0 Y205.0 E200.47578
    G0 F6000 X164.0 Y205.0
    G1 F1200 X164.0 Y145.0 E203.01344
    G0 F6000 X165.0 Y145.0
    G1 F1200 X165.0 Y205.0 E205.55111
    G0 F6000 X166.0 Y205.0
    G1 F1200 X166.0 Y145.0 E208.08878
    G0 F6000 X167.0 Y145.0
    G1 F1200 X167.0 Y205.0 E210.62645
    G0 F6000 X168.0 Y205.0
    G1 F1200 X168.0 Y145.0 E213.16412
    G0 F6000 X169.0 Y145.0
    G1 F1200 X169.0 Y205.0 E215.70179
    G0 F6000 X170.0 Y205.0
    G1 F1200 X170.0 Y145.0 E218.23945
    G0 F6000 X171.0 Y145.0
    G1 F1200 X171.0 Y205.0 E220.77712
    G0 F6000 X172.0 Y205.0
    G1 F1200 X172.0 Y145.0 E223.31479
    G0 F6000 X173.0 Y145.0
    G1 F1200 X173.0 Y205.0 E225.85246
    G0 F6000 X174.0 Y205.0
    G1 F1200 X174.0 Y145.0 E228.39013
    G0 F6000 X175.0 Y145.0
    G1 F1200 X175.0 Y205.0 E230.92779
    G0 F6000 X176.0 Y205.0
    G1 F1200 X176.0 Y145.0 E233.46546
    G0 F6000 X177.0 Y145.0
    G1 F1200 X177.0 Y205.0 E236.00313
    G0 F6000 X178.0 Y205.0
    G1 F1200 X178.0 Y145.0 E238.54080
    G0 F6000 X179.0 Y145.0
    G1 F1200 X179.0 Y205.0 E241.07847
    G0 F6000 X180.0 Y205.0
    G1 F1200 X180.0 Y145.0 E243.61613
    G0 F6000 X181.0 Y145.0
    G1 F1200 X181.0 Y205.0 E246.15380
    G0 F6000 X182.0 Y205.0
    G1 F1200 X182.0 Y145.0 E248.69147
    G0 F6000 X183.0 Y145.0
    G1 F1200 X183.0 Y205.0 E251.22914
    G0 F6000 X184.0 Y205.0
    G1 F1200 X184.0 Y145.0 E253.76681
    G0 F6000 X185.0 Y145.0
    G1 F1200 X185.0 Y205.0 E256.30447
    G0 F6000 X186.0 Y205.0
    G1 F1200 X186.0 Y145.0 E258.84214
    G0 F6000 X187.0 Y145.0
    G1 F1200 X187.0 Y205.0 E261.37981
    G0 F6000 X188.0 Y205.0
    G1 F1200 X188.0 Y145.0 E263.91748
    G0 F6000 X189.0 Y145.0
    G1 F1200 X189.0 Y205.0 E266.45515
    G0 F6000 X190.0 Y205.0
    G1 F1200 X190.0 Y145.0 E268.99281
    G0 F6000 X191.0 Y145.0
    G1 F1200 X191.0 Y205.0 E271.53048
    G0 F6000 X192.0 Y205.0
    G1 F1200 X192.0 Y145.0 E274.06815
    G0 F6000 X193.0 Y145.0
    G1 F1200 X193.0 Y205.0 E276.60582
    G0 F6000 X194.0 Y205.0
    G1 F1200 X194.0 Y145.0 E279.14349
    G0 F6000 X195.0 Y145.0
    G1 F1200 X195.0 Y205.0 E281.68115
    G0 F6000 X196.0 Y205.0
    G1 F1200 X196.0 Y145.0 E284.21882
    G0 F6000 X197.0 Y145.0
    G1 F1200 X197.0 Y205.0 E286.75649
    G0 F6000 X198.0 Y205.0
    G1 F1200 X198.0 Y145.0 E289.29416
    G0 F6000 X199.0 Y145.0
    G1 F1200 X199.0 Y205.0 E291.83183
    G0 F6000 X200.0 Y205.0
    G1 F1200 X200.0 Y145.0 E294.36949
    G0 F6000 X201.0 Y145.0
    G1 F1200 X201.0 Y205.0 E296.90716
    G0 F6000 X202.0 Y205.0
    G1 F1200 X202.0 Y145.0 E299.44483
    G0 F6000 X203.0 Y145.0
    G1 F1200 X203.0 Y205.0 E301.98250
    G0 F6000 X204.0 Y205.0
    G1 F1200 X204.0 Y145.0 E304.52017
    G0 F6000 X205.0 Y145.0

    ; --- Body layers (loop layer 2 .. N) ---
    {% for layer_index in range(1, layers_per_calibration_block) %}
        {% set current_retraction_distance = retraction_distance + (layer_index * retraction_distance_increment) %}
        {% set current_layer_z = starting_z_height + (layer_index * layer_height_mm) %}

        G90
        G1 Z{current_layer_z} F300

        ; ===== Calibration layer (pattern only) =====
        M83
        ; Shared calibration pattern for body layer with per-waypoint retraction changes
        {% set base_retraction_distance = current_retraction_distance %}
        {% for waypoint_index in range(waypoints_per_square) %}
            {% set waypoint_retraction_distance = base_retraction_distance + (waypoint_index * retraction_distance_waypoint_increment) %}
            ; -- Waypoint {{ waypoint_index+1 }} / {{ waypoints_per_square }} --
            ; TODO: move to next square segment/corner here
            G1 F{retraction_feed_rate_mmpm} E-{waypoint_retraction_distance}
            G1 F{retraction_feed_rate_mmpm} E{waypoint_retraction_distance}
        {% endfor %}
    {% endfor %}
