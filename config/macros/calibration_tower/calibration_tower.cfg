[gcode_macro CONFIGURATION_TOWER]
description: |
    Generates a multi-stage tuning tower for 3D printer retraction calibration.
    The model is divided into groups of LAYERS_PER_TEST layers, each group representing
    one test iteration. Between groups, retraction speed, nozzle temperature, and fan
    speed can be incremented according to the parameters below. Within each group,
    retraction distance is gradually increased layer by layer. This allows you to
    visually compare the effects of different retraction settings across a single print.

    Special modes:
    - Set CALIBRATION_BLOCKS=0 to print only the initial mesh layer
    - Set CALIBRATION_BLOCKS=1 to print mesh + one calibration block
gcode:
    # ===== CONFIGURATION_TOWER - Main calibration tower generator =====
    # This macro orchestrates the entire calibration process by:
    # 1. Setting up initial conditions (bed, nozzle, fan)
    # 2. Laying down an initial mesh for adhesion (always prints)
    # 3. Calling _CALIBRATION_BLOCK iteratively for each test group (if any)
    # 4. Incrementing parameters between test groups

    # ===== Configuration Parameters =====
    # Tower dimensions and basic settings
    {% set dimension_x = params.DIMENSION_X|default(350)|float %}
    {% set dimension_y = params.DIMENSION_Y|default(350)|float %}
    {% set print_speed = params.PRINT_SPEED|default(40.0)|float %}
    {% set bed_temp = params.BED_TEMP|default(75)|float %}
    {% set nozzle_diameter = params.NOZZLE_DIAMETER|default(0.4)|float %}
    {% set filament_diameter = params.FILAMENT_DIAMETER|default(1.7)|float %}
    {% set extrusion_multiplier = params.EXTRUSION_MULTIPLIER|default(1.0)|float %}
    {% set layer_height = params.LAYER_HEIGHT|default(0.2)|float %}
    {% set layers_per_test = params.LAYERS_PER_TEST|default(25.0)|float %}
    {% set calibration_blocks = params.CALIBRATION_BLOCKS|default(15.0)|float %}

    # Retraction settings
    {% set starting_retraction_distance = params.STARTING_RETRACTION_DISTANCE|default(0.5)|float %}
    {% set increment_retraction = params.INCREMENT_RETRACTION|default(0.25)|float %}
    {% set start_retraction_speed = params.START_RETRACTION_SPEED|default(10.0)|float %}
    {% set retraction_speed_increment = params.RETRACTION_SPEED_INCREMENT|default(10.0)|float %}

    # Temperature settings
    {% set starting_temp = params.STARTING_TEMP|default(215)|float %}
    {% set increment_temp = params.INCREMENT_TEMP|default(0)|float %}

    # Fan settings
    {% set fan_speed = params.FAN_SPEED|default(40)|float %}
    {% set fan_speed_increment = params.FAN_SPEED_INCREMENT|default(0)|float %}

    # ===== Initial Setup =====
    ; Set bed temperature and wait
    M140 S{bed_temp}
    M190 S{bed_temp}

    ; Set initial nozzle temperature
    M104 S{starting_temp}
    M109 S{starting_temp}

    ; Set initial fan speed
    M106 S{fan_speed}

    ; Home all axes
    G28

    ; Set initial print speed
    M220 S{print_speed}

    # ===== Initial Mesh Layer for Adhesion =====
    ; This creates a solid foundation for the calibration blocks to adhere to
    ; Always prints regardless of number of calibration blocks
    ; Pattern matches the original: 60x60mm zigzag centered at (175,175)
    G90
    G1 Z0.2 F300

    ; Print the original zigzag mesh pattern (60x60mm centered at 175,175)
    ; X range: 145.0 to 205.0, Y range: 145.0 to 205.0
    {% set mesh_start_x = 145.0 %}
    {% set mesh_end_x = 205.0 %}
    {% set mesh_start_y = 145.0 %}
    {% set mesh_end_y = 205.0 %}

    ; Move to starting position
    G1 F6000 X{mesh_start_x} Y{mesh_start_y} Z0.2

    ; Generate zigzag pattern matching the original
    {% set current_e = 2.53767 %}
    {% set e_increment = 2.53767 %}

    ; First pass: left to right, then right to left (zigzag)
    {% for y in range(mesh_start_y, mesh_end_y + 1, 1) %}
        {% if y % 2 == 0 %}
            ; Even Y: right to left
            G0 F6000 X{mesh_end_x} Y{y}
            G1 F1200 X{mesh_start_x} Y{y} E{current_e}
        {% else %}
            ; Odd Y: left to right
            G0 F6000 X{mesh_start_x} Y{y}
            G1 F1200 X{mesh_end_x} Y{y} E{current_e}
        {% endif %}
        {% set current_e = current_e + e_increment %}
    {% endfor %}

    ; If no calibration blocks requested, exit after mesh
    {% if calibration_blocks == 0 %}
        M117 Mesh layer complete!
        ; Move to safe position and end
        G90
        G1 Z10 F300
        G1 X{dimension_x/2} Y{dimension_y/2} F6000
        ; Turn off heaters and fan
        M104 S0
        M140 S0
        M106 S0
        RETURN
    {% endif %}

    # ===== Calibration Blocks =====
    ; Generate each test group by calling _CALIBRATION_BLOCK
    {% for test_group in range(calibration_blocks) %}
        {% set current_retraction_speed = start_retraction_speed + (test_group * retraction_speed_increment) %}
        {% set current_temp = starting_temp + (test_group * increment_temp) %}
        {% set current_fan = fan_speed + (test_group * fan_speed_increment) %}
        {% set current_z_height = 0.2 + (test_group * layers_per_test * layer_height) %}

        ; Call the calibration block macro for this test group
        _CALIBRATION_BLOCK \
            RETRACTION_DISTANCE={starting_retraction_distance} \
            RETRACTION_SPEED_MMS={current_retraction_speed} \
            NOZZLE_TEMPERATURE={current_temp} \
            FAN_SPEED_PERCENT={current_fan} \
            LAYERS_PER_CALIBRATION_BLOCK={layers_per_test} \
            RETRACTION_DISTANCE_INCREMENT={increment_retraction} \
            LAYER_HEIGHT_MM={layer_height} \
            STARTING_Z_HEIGHT={current_z_height}
    {% endfor %}

    # ===== Finalization =====
    ; Always return to safe position
    {% set final_z = 0.2 + (calibration_blocks * layers_per_test * layer_height) %}
    G90
    G1 Z{final_z + 10} F300
    G1 X{dimension_x/2} Y{dimension_y/2} F6000

    ; Turn off heaters and fan
    M104 S0
    M140 S0
    M106 S0

    ; Display completion message
    {% if calibration_blocks == 0 %}
        M117 Mesh layer complete!
    {% elif calibration_blocks == 1 %}
        M117 Single calibration block complete!
    {% else %}
        M117 Calibration tower complete!
    {% endif %}
