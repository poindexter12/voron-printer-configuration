[gcode_macro _DRAW_PERIMETER_LAYER]
description: Draw a rectangular perimeter layer with multiple perimeters stepping inward
parameters:
  START_X: Starting X coordinate (bottom-left)
  START_Y: Starting Y coordinate (bottom-left)
  WIDTH: Total width of the perimeter (mm)
  HEIGHT: Total height of the perimeter (mm)
  LINE_WIDTH: Line width (mm)
  LAYER_HEIGHT: Layer height (mm)
  NUM_PERIMETERS: Number of perimeters to draw (default 4)
  STEP_DISTANCE: Distance to step inward for each perimeter (mm, default 0.5)
  SPEED: Print speed (mm/s, default 100)
  FILAMENT_DIAMETER: Filament diameter (mm, default 1.75)
  EXTRUSION_MULTIPLIER: Extrusion multiplier (default 1.0)
gcode:
  {# Draw multiple perimeters stepping inward #}
  {% for i in range(NUM_PERIMETERS|default(4)) %}
    {# Calculate current perimeter dimensions #}
    {% set current_step = i * (STEP_DISTANCE|default(0.5)) %}
    {% set current_x = START_X + current_step %}
    {% set current_y = START_Y + current_step %}
    {% set current_width = WIDTH - (2 * current_step) %}
    {% set current_height = HEIGHT - (2 * current_step) %}
    
    {# Calculate extrusion for each line #}
    {% set PI = 3.141592653589793 %}
    {% set line_area = (LINE_WIDTH - LAYER_HEIGHT) * LAYER_HEIGHT + PI * (LAYER_HEIGHT/2)**2 %}
    {% set filament_area = PI * (FILAMENT_DIAMETER|default(1.75)/2)**2 %}
    {% set extrusion_per_mm = (line_area / filament_area) * (EXTRUSION_MULTIPLIER|default(1.0)) %}
    
    {# Draw perimeter rectangle (up, right, down, left) #}
    {# Up line #}
    {% set up_extrusion = extrusion_per_mm * current_height %}
    G1 X{current_x} Y{current_y + current_height} E{up_extrusion} F{SPEED * 60} ; Draw perimeter (up)
    
    {# Right line #}
    {% set right_extrusion = extrusion_per_mm * current_width %}
    G1 X{current_x + current_width} Y{current_y + current_height} E{right_extrusion} F{SPEED * 60} ; Draw perimeter (right)
    
    {# Down line #}
    {% set down_extrusion = extrusion_per_mm * current_height %}
    G1 X{current_x + current_width} Y{current_y} E{down_extrusion} F{SPEED * 60} ; Draw perimeter (down)
    
    {# Left line #}
    {% set left_extrusion = extrusion_per_mm * current_width %}
    G1 X{current_x} Y{current_y} E{left_extrusion} F{SPEED * 60} ; Draw perimeter (left)
    
    {# Step inward for next perimeter (unless this is the last one) #}
    {% if i < (NUM_PERIMETERS|default(4)) - 1 %}
      G0 X{current_x + (STEP_DISTANCE|default(0.5))} Y{current_y + (STEP_DISTANCE|default(0.5))} F7200 ; Step inwards to print next perimeter
    {% endif %}
  {% endfor %}